Analysis of Covid-19 chest X-ray images
=======================================

This project aims to train a deep learning model to classify Chest X-ray images [dataset](https://www.kaggle.com/datasets/tawsifurrahman/covid19-radiography-database).

## Context

A team of researchers from multiple universities in the Middle East and Asia have assembled a dataset of chest X-rays for healthy patients with Covid, pneumonia and lung opacity.

This dataset was assembled with the aim of using deep learning to diagnose Covid-19 by X-ray rather than RT-PCR.

There are 4 image sources present in the dataset (with the number of images in brackets):
- COVID-19 data (3615)
- Normal images (10192)
- Lung opacity images (6012)
- Viral Pneumonia images (1345)

Each image comes with its own pre-calculated mask, generated by semi-automatic learning.
The application can therefore isolate the lungs and provide lung-only data.

## Objective

The primary goal of this project is to leverage this dataset to aid in the diagnosis of lung diseases. This constitutes a multi-class classification problem.

A key objective will be to minimize the occurrence of false negatives, i.e., instances where an X-ray is incorrectly classified as normal when, in fact, the patient is infected.

## Project Conclusion

The EfficientNetB4 model was chosen for its performance. On data including only the lung area, 92% accuracy was obtained.

## Project Usage

The project was developed using Jupyter Notebook for exploratory data analysis and to facilitate experimentation with various frameworks and models.

The src folder is structured as a Python module, although the main scripts are intended to be executed directly via the command line interface (CLI).

## Building the environment

The file `requirements.txt` will contain the necessary modules for this project. It can be used to build your environment with your prefered method ([conda](https://docs.conda.io/projects/conda/en/latest/user-guide/tasks/manage-environments.html), [venv](https://packaging.python.org/en/latest/guides/installing-using-pip-and-virtual-environments/), ...).

## Using the Scripts

Each script employs default arguments that are relative to the script's execution directory to compute the EfficientNetB4 model.

Other models are available to be trained on the same data:

- DenseNet169
- EfficientNetB0
- EfficientNetB4
- ResNet101
- VGG19

`To ensure correct execution, it is essential to navigate to the scripts subdirectory before launching any script, as they rely on inter-file imports.`

### 1. Downloading and processing the input data

```bash
cd src/features/
python3 build_features.py 
```

### 2. Training and saving the model

```bash
cd src/model/
python3 train_model.py 
```

### 3. Evaluating the model

```bash
cd src/model/
python3 predict_model.py --model_name YourModelName.keras
```

### 4. plotting the Grad-CAM visualisation

```bash
cd src/visualization/
python3 predict_model.py --model_name YourModelName.keras
```

After all computation the model folder which is used by default for output will look like this:

    models/
    ├── <model_type>-<acc>.keras
    ├── Grad-CAM.png
    ├── classification_report.csv
    ├── confusion_matrix.png
    └── training_history.png

The name of the model is defined automatically using the model name and its test accuracy : `<model_type>-<acc>.keras`

For each script more information on their arguments and possible value can be access using:

```bash
python3 script.py --help
```

### Optionnal segmentation for supplementtary data

As the model use masked image we provide two script to transform automatically any X-ray into a masked image.

#### 1. Training the segmentation model

The script `seg_train_model.py` can be use to train a U-Net model on the previous Kaggle dataset. 
This model will be used to predict the lung region on any given X-ray.

```bash
cd src/model/
python3 seg_train_model.py
```

#### 2. Using the model to produce the masked image

Once the model train it can be used with the following command to convert an image or a folder containing any number of X-ray.

Command for converting a file

```bash
cd src/model/
python3 seg_predict_model.py --model_name <model_name>.keras --filepath <image_path>
```

or for a folder:

```bash
cd src/model/
python3 seg_predict_model.py --model_name <model_name>.keras --folderpath <folder_path>
```

By default the command produced a mask image the same size of the original picture.
It can be changed using the arguments: `--output_height` and `--output_width`. As the script `build_features.py` use 256*256 pixels images it is recommanded to use the argument if you want to use to predict the image afterward.

## Project Organization
   
    .
    ├── LICENSE
    ├── README.md          <- The top-level README for developers using this project.
    ├── data
    │   ├── processed      <- The final, canonical data sets for modeling.
    │   └── raw            <- The original, immutable data dump.
    │
    ├── models             <- Trained and serialized models, model predictions,
    │                         or model summaries
    ├── notebooks          <- Jupyter notebooks.
    │
    ├── references         <- Data dictionaries, manuals, links, and all 
    │                         other explanatory materials.
    ├── reports            <- The reports that you'll make during this project as PDF
    │   └── figures        <- Generated graphics and figures to be used in reporting
    │
    ├── requirements.txt   <- The requirements file for reproducing the analysis
    │                         environment.
    │
    └── src                <- Source code for use in this project.
        ├── __init__.py    <- Makes src a Python module
        │
        ├── features       <- Scripts to turn raw data into features for modeling
        │   └── build_features.py
        │
        ├── models         <- Scripts to train models and then use trained models
        │   │                 to make predictions
        │   ├── predict_model.py
        │   ├── train_model.py
        │   ├── seg_predict_model.py
        │   └── seg_train_model.py
        │
        └── visualization  <- Scripts to create exploratory and results
            │                 oriented visualizations
            └── visualize.py

--------

<p><small>Project based on the <a target="_blank" href="https://drivendata.github.io/cookiecutter-data-science/">cookiecutter data science project template</a>. #cookiecutterdatascience</small></p>
